name: Deploy to VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-archetypy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script_stop: true
          script: |
            /usr/local/bin/archetypy-deploy

      - name: Healthcheck
        shell: bash
        run: |
          set -e
          # Czekamy aż strona zacznie zwracać 200 (max ~90s)
          for i in {1..30}; do
            code=$(curl -fsSLk -o /dev/null -w "%{http_code}" https://panel.archetypy.badania.pro/ || true)
            echo "Probe $i -> HTTP $code"
            if [ "$code" = "200" ]; then
              echo "Site is healthy."
              exit 0
            fi
            sleep 3
          done
          echo "Healthcheck failed."
          exit 1
