name: Deploy to VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-archetypy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key from secret (base64)
        shell: bash
        env:
          KEY_B64: ${{ secrets.SERVER_SSH_KEY_B64 }}
        run: |
          set -euxo pipefail
          umask 077
          mkdir -p ~/.ssh
          echo "$KEY_B64" | base64 -d > ~/.ssh/id_ed25519
          # dla pewności pokaż publiczny klucz z sekretu (jawny, bezpieczny)
          ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub
          echo "Runner public key (must match server):"
          cat ~/.ssh/id_ed25519.pub

      - name: Make remote deploy script
        shell: bash
        run: |
          set -euxo pipefail
          cat > remote_deploy.sh <<'EOS'
          set -euxo pipefail
          cd /srv/archetypy-admin
          git config --global --add safe.directory /srv/archetypy-admin
          git fetch --all
          git reset --hard origin/main
          . .venv/bin/activate
          pip install --no-cache-dir -r requirements.txt
          sudo systemctl restart archetypy-admin
          systemctl --no-pager -l status archetypy-admin | sed -n '1,120p'
          EOS
          chmod +x remote_deploy.sh

      - name: Copy & run remote script over SSH
        shell: bash
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          PORT: ${{ secrets.SERVER_PORT }}
        run: |
          set -euxo pipefail
          scp -P "$PORT" -o StrictHostKeyChecking=no -o IdentitiesOnly=yes \
              -i ~/.ssh/id_ed25519 remote_deploy.sh "$USER@$HOST:/tmp/remote_deploy.sh"
          ssh -p "$PORT" -o StrictHostKeyChecking=no -o IdentitiesOnly=yes \
              -i ~/.ssh/id_ed25519 "$USER@$HOST" "bash /tmp/remote_deploy.sh"

      - name: Healthcheck
        shell: bash
        run: |
          set -e
          for i in {1..30}; do
            code=$(curl -fsSLk -o /dev/null -w "%{http_code}" https://panel.archetypy.badania.pro/)
            echo "Probe $i -> HTTP $code"
            if [ "$code" = "200" ]; then
              echo "OK"
              exit 0
            fi
            sleep 3
          done
          echo "Healthcheck failed."
          exit 1
